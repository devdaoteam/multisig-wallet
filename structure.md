# Устройство DevDao

Устройство в 3х типах смарт-контрактов (считая NFT и коллекцию одним
контрактом):
- Токенсиг DevDao
- Распределитель для работников "сферы услуг" DevDao
- Распределитель-проект, или Контракт проекта

# Токенсиг DevDao

### Кратко:

Это кошелек, сообщения с которого могут отправляться только по
решению голосования токенами.

При начале голосования, он получает эмиссию данного токена и высчитывает
максимум голосов. Каждый член по умолчанию имеет 1 голос. Количество его
токенов добавляет ему некоторое количество голосов, которое зависит от
количества участников Dao.

Голосование происходит отправкой токенов в контракт. Контракт считает
голос для каждого члена Dao и блокирует у себя токены.

По достижению большинства голосов, сообщение отправляется и всем
возвращаются их токены. Если нужное количество голосов не набирается,
через несколько суток (допустим трое), всем возвращаются токены и ничего
не отправляется.

### Расчет голосов

> Чтобы предотвратить ситуацию, когда активный член Dao владеет
> большинством токенов и может единолично побеждать в голосовании, вес
> токенов в голосовании непостоянен и расчитывается из количества
> участников Dao.

Пусть $E$ - эмиссия токенов в момент начала голосования. $M$ - количество
участников Dao.
\
Один из членов Dao отправляет свой голос
и количество токенов $C$.

$P$ - его доля от всей эмиссии $E$.

$P = \frac{C}{E}$

Обозначим за $V$ количество голосов, которое дает участнику его доля $P$
и введем фактор влияния (коэффициент) $F$, тогда:

$F = \frac{V}{P}$

Чем больше участников, тем сложнее завладеть всеми токенами.
Следовательно, чем больше Dao, тем больше голосов могут значить токены. $F
\sim M$.

$F = rM$, где $r$ - коэффициент пропорциональности.

##### Для вывода коэффициента смоделируем ситуацию:

Пускай, если в Dao состоит $M_{1}=2$ человека, владение половиной токенов
($C = \frac{1}{2}\times{E} \Rightarrow P = 0.5$) должно давать $V_{1} = 1$
голос. Тогда $F_{1} = \frac{V_{1}}{P_{1}} = \frac{1}{0.5} = 2$.

И пускай, если в Dao будет состоять $M_{2}=102$ человека, обладание
половиной токенов ($P = 0.5$) будет давать $V_{2} = 11$ голосов. Тогда
$F_{2} = \frac{V_{2}}{P_{2}} = \frac{11}{0.5} = 22$.

##### Выведеем $r$:

$r = \frac{\Delta F}{\Delta M} = \frac{F_{2} - F{1}}{M_{2} - M_{1}}
= \frac{22 - 2}{102 - 2} = \frac{20}{100} = 0.2$


### Применение 

##### Формула расчета максимального количества голосов $A$

$A = M + rM$ или $A = M(r + 1)$

##### Формула расчета голосов $K$ для каждого голосующего

$K = 1 + P \times F$ или $K = 1 + \frac{C}{E} \times rM$

##### Выражения для интегрирования в код

`max_votes = total_members * (r + 1)`

`one_user_votes = 1 + (user_tokens / emission) r * total_members`


# Контракт проекта

DevDao подразделяется на множество проектов.

Проект представляет собой контракт с интерфейсом NFT-коллекции.

Её NFT принадлежат тем, кто занимался разработкой или продвижением
проекта, т.е. совершал для него какую-то работу.

Колличество NFT в проекте не превышает 250.

Проект минтится одной транзакцией от Токенсига DevDao.

В инициализирующей транзакции указываются сразу адреса и доли всех
участников проекта. Участниками могут быть **только члены DevDao**,
которые принимают участие в голосовании в Токенсиге DevDao. Во время
инита минтятся сразу и все NFT для участников.

В контракте есть 2 важных dict'а:
1. Хранит информацию о долях по индексу NFT как ключ, пример:
    - `0, 0.1` - владелец NFT с индексом 0 получает 10%
    - `1, 0.5` - следующий 50%
    - `2, 0.2` - 20%
    - `3, 0.1` - 10%
    - `777, 0.1` - А это запись баланса для фонда DevDao

2. Хранит балансы подобным образом.
    - `0, 15*10^9` - У владельца NFT с индексом 0 на балансе 15 TON
    - `1, 75*10^9` - У этого 75
    - `2, 0`       - Этот видимо недавно вывел деньги
    - `3, 15*10^9` - У этого 15
    - `777, 10*10^9` - А это запись баланса для фонда DevDao

На контракт проекта приходят все деньги, вырученные продуктом, который был
разработан в рамках этого проекта. Контракт начисляет деньги на балансы во
втором словаре согласно долям в первом. Если на балансе фонда денег
больше, чем 50 TON, он отсылает 90% этого баланса на Токенсиг DevDao
и 10% на распределитель нематериальным работникам.

NFT же может принять от его владельца запрос на вывод средств с контракта
проекта. Тогда NFT формирует и отправляет сообщение коллекции с нужным op
и со своим индексом и адресом владельца в теле. Контракт проекта проверяет
по индексу, что сообщение действительно от NFT и выводит владельцу его
баланс.


# Распределитель для духовенства DevDao

По структуре вывода, баланса и долей он идентичен контракту проекта. За
исключением, разве что, 10% в фонд. Тут всё распределяется только между
владельцами NFT.

Распределитель может полностью управляться Токенсигом DevDao. Токенсиг
может поменять доли, заминтить новую NFT, передать уже существующую.
